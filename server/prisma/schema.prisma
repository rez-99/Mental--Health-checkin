// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id        String   @id @default(uuid())
  name      String
  district  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users    User[]
  students Student[]

  @@map("schools")
}

model User {
  id        String   @id @default(uuid())
  schoolId  String   @map("school_id")
  authSub   String   @unique @map("auth_sub") // Auth0/Azure AD subject ID
  role      UserRole
  name      String
  email     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdFollowUps FollowUp[]

  @@map("users")
}

enum UserRole {
  COUNSELLOR
  ADMIN
}

model Student {
  id               String         @id @default(uuid())
  schoolId         String         @map("school_id")
  externalStudentId String?        @map("external_student_id") // From SIS/SSO
  displayName      String         @map("display_name")
  grade            Int?
  consentStatus    ConsentStatus  @default(PENDING) @map("consent_status")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  school    School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  checkIns  CheckIn[]
  auditLogs AuditLog[]
  skillSessions SkillSession[]
  flags     Flag[]
  safetyPlan SafetyPlan?
  notificationPreference StudentNotificationPreference?
  followUps FollowUp[]

  @@map("students")
}

enum ConsentStatus {
  PENDING
  GRANTED
  DENIED
}

model CheckIn {
  id            String     @id @default(uuid())
  studentId     String     @map("student_id")
  createdAt     DateTime   @default(now()) @map("created_at")
  
  // Mood & basics
  mood          Int        // 1-5
  sleepQuality  Int        @map("sleep_quality") // 1-5
  concentration Int        // 1-5
  energy        Int        // 1-5
  worries       Int        // 1-5
  burden        Int        // 1-5
  
  // Optional fields
  notes         String?    @db.Text
  cognitiveScore Int?       @map("cognitive_score")
  screenUseImpact String?   @map("screen_use_impact")
  
  // Calculated risk
  riskScore     Float      @map("risk_score")
  riskLevel     RiskLevel  @map("risk_level")
  flags         Json?      // e.g., { "three_low_mood_weeks": true }
  
  // Screening scores
  phqScore      Int?       @map("phq_score")
  gadScore      Int?       @map("gad_score")
  safetyRisk    String?    @map("safety_risk") // 'low' | 'moderate' | 'high' | 'immediate'
  
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  followUps FollowUp[]

  @@index([studentId])
  @@index([createdAt])
  @@index([riskLevel])
  @@map("check_ins")
}

enum RiskLevel {
  green
  yellow
  red
}

model AuditLog {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id") // Nullable for system actions
  schoolId  String?     @map("school_id")
  studentId String?     @map("student_id")
  type      AuditType
  details   Json?
  createdAt DateTime    @default(now()) @map("created_at")

  student Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([schoolId])
  @@index([studentId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditType {
  VIEW_STUDENT
  EXPORT_DATA
  CHANGE_CONSENT
  CREATE_CHECK_IN
  VIEW_DASHBOARD
  ADD_NOTE
  FOLLOW_STUDENT
}

// Skills Paths System
model SkillPath {
  id          String   @id @default(uuid())
  name        String   // "Feeling anxious", "Feeling sad", "Can't sleep", "Angry / overwhelmed"
  description String?  @db.Text
  icon        String?  // emoji
  modules     Json     // Array of module definitions
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  sessions    SkillSession[]
  
  @@map("skill_paths")
}

model SkillSession {
  id          String   @id @default(uuid())
  studentId   String   @map("student_id")
  pathId      String   @map("path_id")
  pathName    String   @map("path_name") // Denormalized for easy queries
  preMood     Int?     @map("pre_mood") // 1-5
  postMood    Int?     @map("post_mood") // 1-5
  completedAt DateTime @map("completed_at")
  createdAt   DateTime @default(now())
  
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  path   SkillPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([completedAt])
  @@map("skill_sessions")
}

// Early Warning Flags
model Flag {
  id          String   @id @default(uuid())
  studentId   String   @map("student_id")
  type        FlagType
  severity    String   // "low" | "moderate" | "high"
  resolvedAt  DateTime? @map("resolved_at")
  createdAt   DateTime @default(now())
  
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, type])
  @@index([studentId])
  @@index([type])
  @@index([createdAt])
  @@map("flags")
}

enum FlagType {
  SUSTAINED_LOW_MOOD_SLEEP
  RAPID_DECLINE
  HIGH_WORRIES
  HIGH_BURDEN
  CRISIS_INDICATOR
}

// Notification Preferences
model StudentNotificationPreference {
  id                String   @id @default(uuid())
  studentId         String   @unique @map("student_id")
  lowMoodReminder   Boolean  @default(true) @map("low_mood_reminder")
  notifyTrustedAdult Boolean @default(false) @map("notify_trusted_adult")
  notifyCounsellor  Boolean  @default(false) @map("notify_counsellor")
  trustedAdultEmail String?  @map("trusted_adult_email")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@map("student_notification_preferences")
}

// Safety Plans
model SafetyPlan {
  id                String   @id @default(uuid())
  studentId         String   @unique @map("student_id")
  warningSigns      String[] @map("warning_signs") // Array of strings
  copingStrategies  String[] @map("coping_strategies")
  reasonsToStaySafe String[] @map("reasons_to_stay_safe")
  peopleWhoCanHelp  Json     @map("people_who_can_help") // [{name, contact, relationship}]
  crisisResources   Json?    @map("crisis_resources") // Local crisis lines
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@map("safety_plans")
}

// Follow-ups for counselor workflow
model FollowUp {
  id          String          @id @default(uuid())
  
  // Relations
  studentId   String          @map("student_id")
  student     Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  createdById String          @map("created_by_id") // counselor / staff who created it
  createdBy   User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  // Optional: which check-in triggered this follow-up
  checkInId   String?         @map("check_in_id")
  checkIn     CheckIn?        @relation(fields: [checkInId], references: [id], onDelete: SetNull)
  
  // Core fields
  status      FollowUpStatus
  scheduledAt DateTime?       @map("scheduled_at") // date + time of meeting / call
  notes       String?         @db.Text // counselor notes
  actionTaken String?         @map("action_taken") @db.Text // e.g. "Met with student", "Called parent"
  
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  @@index([studentId])
  @@index([createdById])
  @@index([status])
  @@index([scheduledAt])
  @@map("follow_ups")
}

enum FollowUpStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  NO_ACTION_NEEDED
}

